\chapter{Appendix}
\label{cha:appendix}

\section{Definition of Collective Variables}
\label{sec:reaction coordinates}

In the present work distances, projected distances, angles and torsion angles between groups of atoms were used as collective variables for US, MtD, ABF, eABF or meta-eABF simulations.
Below analytic expressions for the calculation of all CVs, their gradients, inverse gradients and divergence of inverse gradients are given.

The center of mass $r^C$ of a group of $N$ atoms is calculated according to
\begin{equation}
  r^C(\textbf{x}) = \frac{1}{M^C} \sum_{i=0}^N m_i r_i
\end{equation}
with mass of each atom $m_i$ and Cartesian coordinates $r_i = (x_i,y_i,z_i)$. $M^C$ is the mass of the group.
All following collective variables are calculated between centers of mass. The index C will be dropped for convenience.
To obtain derivatives of single atoms the gradient its corresponding group is weighted with $m_i/M$.
The distances between group i and j is given by
\begin{equation}
 r_{ij} = r_j - r_i
\end{equation}
and the absolute distance is $d_{ij} = \| r_{ij}\|$.
The derivatives with respect to $r_i$ and $r_j$ are defined by
\begin{equation}
  \frac{\partial d_{ij}}{\partial r_j} = \frac{r_{ij}}{\|r_{ij}\|} = \hat{r}_{ij}
\end{equation}
\begin{equation}
  \frac{\partial d_{ij}}{\partial r_i} = - \hat{r}_{ij}
\end{equation}
where the hat denotes unit vectors.
The projection of distance $\| r_{ij}\|$ onto another axis $r_{jk}$ is defined by
\begin{equation}
  d^p_{ij} = r_{ij} \cdot \hat{r}_{jk}
\end{equation}
and the derivative of the projection is defined by
\begin{equation}
   \frac{\partial d^p_{ij}}{\partial r_i} = -\hat{r}_{jk}
\end{equation}
\begin{equation}
   \frac{\partial d^p_{ij}}{\partial r_j} = \hat{r}_{jk}
\end{equation}
The bond angle $\theta$ between three centers ($r_i, r_j, r_k$) is defined by the dot product of bond distances $r_{ji}$ and $r_{jk}$:
\begin{equation}
  \cos \theta = \hat{r}_{ji} \cdot \hat{r}_{jk}
\end{equation}
The gradient of $\theta$ is then given by
\begin{equation}
  \frac{\partial \theta}{\partial r_i} = \frac{(r_{ji} \times (r_{ji} \times r_{jk})) }{\| r_{ij}\| \| (r_{ji} \times (r_{ji} \times r_{jk})) \|}
\end{equation}
\begin{equation}
  \frac{\partial \theta}{\partial r_k} = \frac{(r_{kj} \times (r_{ji} \times r_{ji}))}{\| r_{kj}\| \| (r_{kj} \times (r_{ji} \times r_{ji})) \|}
\end{equation}
\begin{equation}
  \frac{\partial \theta}{\partial r_j}= -\frac{\partial \theta}{\partial r_i} - \frac{\partial \theta}{\partial r_k}
\end{equation}
The torsion angle $\phi$ between four Cartesian coordinates ($r_i, r_j, r_k, r_l$) is given by:
\begin{equation}
  \tan \phi = \frac{(\hat{r}_{ij} \times n_1) \cdot n_2}{n_1 \cdot n_2}
\end{equation}
with
\begin{equation}
  n_1 = r_{jk} - (r_{ij} \cdot \hat{r}_{jk})\hat{r}_{jk}
\end{equation}
\begin{equation}
  n_2 = r_{kl} - (r_{kl} \cdot \hat{r}_{jk})\hat{r}_{jk}
\end{equation}
The derivative of $\phi$ in Cartesian coordinates is given by:
\begin{equation}
  \frac{\partial\phi}{\partial r_i} = - \frac{\hat{r}_{ji}\times\hat{r}_{jk}}{\|r_{ij}\|\sin^2\theta_{ijk}}
\end{equation}
\begin{equation}
  \frac{\partial\phi}{\partial r_l} = - \frac{\hat{r}_{kl}\times\hat{r}_{jk}}{\|r_{kl}\|\sin^2\theta_{jkl}}
\end{equation}
\begin{equation}
  \frac{\partial\phi}{\partial r_j} = \bigl(\frac{\|r_{ij} \| \cos\theta_{ijk}}{\|r_{jk} \|}-1\bigr) \frac{\partial\phi}{\partial r_i} - \bigl( \frac{\|r_{kl} \| \cos\theta_{jkl}}{\|r_{jk} \|}\bigr)\frac{\partial\phi}{\partial r_l}
\end{equation}
\begin{equation}
  \frac{\partial\phi}{\partial r_k} = - \frac{\partial\phi}{\partial r_i} - \frac{\partial\phi}{\partial r_l} - \frac{\partial\phi}{\partial r_j}
\end{equation}
where $\partial \phi/\partial r_j$ and $\partial \phi/\partial r_k$ are defined to fulfill the conservation of (angular) momentum.

Always choosing as inverse gradient $\textbf{v}(\xi) = \nabla \xi/\|\nabla \xi \| ^2$ the divergence of vector fields $\textbf{v}_i(\xi)$ are given by
\begin{equation}
  \nabla \cdot \textbf{v}(d) = \frac{2}{d},
\end{equation}
\begin{equation}
  \nabla \cdot \textbf{v}(d^p) = 0,
\end{equation}
\begin{equation}
  \nabla \cdot \textbf{v}(\theta) = \cot \theta,
\end{equation}
\begin{equation}
  \nabla \cdot \textbf{v}(\phi) = 0,
\end{equation}
for distances, projected distances, angles and dihedrals, respectively.

\section{Numerical Examples}
\label{sec:num examples}

To test adaptive biasing methods the 2D test potentials $U_1$ and $U_2$ were used. For numerical tests of adaptive biasing methods a particle with a mass of 10~a.u. is simulated according to Algorithm \ref{alg:ABM} with a step size of 5 fs and at a temperature of 300~K.
\begin{equation}
  U_1(x,y) = a(x-c)^2(x+d)^2 + by^2 \label{eq:U1}
\end{equation}
\begin{equation}
  U_2(x,y) = -\ln\bigl( e^{-a(x-c)^2 - b(y-d)^2} + e^{-a(x+c)^2 - b(y+d)^2} \bigr) \label{eq:U2S}
\end{equation}
\begin{table}[H]
        \centering
        \caption{Free Parameters for definition of $U_1$ and $U_2$.}
        \begin{tabular}{ c | c  c  c  c }
                & a & b & c & d   \\
                \hline
                $U_1$  & $8.0e-6$ kJ/mol & $0.5$ kJ/mol & 80 Bohr & 160 Bohr \\
                $U_2$  & $0.005$ kJ/mol  & $0.040$ kJ/mol & 40 Bohr & 20 Bohr \\
        \end{tabular}
        \label{tab:2D pots}
\end{table}

\begin{figure}[H]
    \centering
    \vspace{-1cm}
    \subfloat[$U_1$]{{\includegraphics[width=0.49\textwidth]{bilder/U1} }}
    \subfloat[$U_2$]{{\includegraphics[width=0.49\textwidth]{bilder/U2} }}
    \caption{Potentials for test calculations}
\label{fig:potentials}%
\end{figure}
